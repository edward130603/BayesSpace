---
title: "BayesSpace"
author: "Edward Zhao, Matt Stone, Xing Ren, and Raphael Gottardo"
date: "2020-08-31"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{BayesSpace}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---




```r
suppressPackageStartupMessages({
  library(SingleCellExperiment)
  library(ggplot2)
  library(BayesSpace)
})
```

## Preprocessing

We'll obtain one of the melanoma samples from the 2018 Spatial Transcriptomics
paper for this example.


```r
sce <- getRDS(dataset="2018_thrane_melanoma", sample="ST_mel1_rep2")
```

Our processed datasets already include PCs, but in general it's necessary to
preprocess samples by running PCA. We recommend running PCA on only the top
highly variable genes.

```r
set.seed(102)
dec <- scran::modelGeneVar(sce)
top <- scran::getTopHVGs(dec, n=2000)
sce <- scater::runPCA(sce, subset_row=top)
```

We can use the `qTune()` and `qPlot()` functions to help choose the number of
clusters to use in our analysis. 

```r
sce <- qTune(sce, platform="ST", d=7, nrep=100)
qPlot(sce)
```

<img src="figures/BayesSpace-tuning_q-1.png" title="plot of chunk tuning_q" alt="plot of chunk tuning_q" width="100%" />

## Clustering
The `spatialCluster()` function will cluster the spots, and add the predicted
cluster labels to `colData(sce)`. Typically, and for analyses in the paper, we
suggest running with at least 10,000 iterations (`nrep=10000`), but we use 1,000
iteration in this demonstration for the sake of runtime.


```r
set.seed(149)
sce <- spatialCluster(sce, q=4, platform="ST", d=7,
                      init.method="mclust", model="t", nrep=1000, 
                      save.chain=TRUE)
```

Both the mclust initialization (`cluster.init`) and the BayesSpace cluster assignments (`spatial.cluster`) are now available in the SingleCellExperiment's `colData`.

```r
head(colData(sce))
#> DataFrame with 6 rows and 5 columns
#>            row       col sizeFactor cluster.init spatial.cluster
#>      <integer> <integer>  <numeric>    <numeric>       <numeric>
#> 7x15         7        15   0.795588            1               1
#> 7x16         7        16   0.307304            1               1
#> 7x17         7        17   0.331247            2               1
#> 7x18         7        18   0.420747            3               2
#> 8x13         8        13   0.255453            1               1
#> 8x14         8        14   1.473439            1               1
```


We can plot the cluster assignments over the spatial locations of the spots.

```r
clusterPlot(sce, platform="ST")
```

<img src="figures/BayesSpace-cluster.plot-1.png" title="plot of chunk cluster.plot" alt="plot of chunk cluster.plot" width="100%" />

## Enhanced resolution

The `spatialEnhance()` function will enhance the resolution of the principal
components, and add these PCs as well as predicted cluster labels at subspot
resolution to a new SingleCellExperiment.

```r
enhanced <- spatialEnhance(sce, q=4, platform="ST", d=7,
                           model="t", nrep=10000, save.chain=TRUE)
```

The enhanced SingleCellExperiment includes an index to the parent spot in the original `sce` (`spot.idx`), along with an index to the subspot. It adds the offsets to the original spot coordinates, and provides the enhanced cluster label (`spatial.cluster`).

```r
head(colData(enhanced))
#> DataFrame with 6 rows and 9 columns
#>              spot.idx subspot.idx  spot.row  spot.col       row
#>             <numeric>   <integer> <integer> <integer> <numeric>
#> subspot_1.1         1           1         7        15   7.33333
#> subspot_2.1         2           1         7        16   7.33333
#> subspot_3.1         3           1         7        17   7.33333
#> subspot_4.1         4           1         7        18   7.33333
#> subspot_5.1         5           1         8        13   8.33333
#> subspot_6.1         6           1         8        14   8.33333
#>                   col  imagerow  imagecol spatial.cluster
#>             <numeric> <numeric> <numeric>       <numeric>
#> subspot_1.1   15.3333   7.33333   15.3333               1
#> subspot_2.1   16.3333   7.33333   16.3333               1
#> subspot_3.1   17.3333   7.33333   17.3333               4
#> subspot_4.1   18.3333   7.33333   18.3333               3
#> subspot_5.1   13.3333   8.33333   13.3333               1
#> subspot_6.1   14.3333   8.33333   14.3333               1
```


We can plot the enhanced cluster assignments as above.

```r
enhancePlot(enhanced, platform="ST")
```

<img src="figures/BayesSpace-enhance.plot-1.png" title="plot of chunk enhance.plot" alt="plot of chunk enhance.plot" width="100%" />

Note that the enhanced PCs are stored as a `reducedDim` and the enhanced
SingleCellExperiment has no assays. To impute expression (or other features) at
subspot resolution, we need to run `enhanceFeatures()` afterwards.

By default, log-normalized expression (`logcounts(sce)`) is imputed, but other
assays or arbitrary features can be specified.

```r
enhanced <- enhanceFeatures(enhanced, sce) 
```

TODO: add outputs/plot for enhanceFeatures

## Accessing Markov chains

If `save.chain` is set to `TRUE` in either `spatialCluster()` or
`spatialEnhance()`, the chain associated with the respective MCMC run is
preserved to disk as an HDF5 file. The path to this file is stored in the
SingleCellExperiment's metadata at `metadata(sce)$h5.chain`, and can be read
directly using `mcmcChain()`.

The chain is provided as a `coda::mcmc` object, which can be analyzed with
[TidyBayes](https://mjskay.github.io/tidybayes/) or as a matrix. The object has
one row per iteration, with the values of the parameters concatenated across the
row. Columns are named with the parameter name and index (if any).

```r
chain <- mcmcChain(sce)
chain[1:5, 1:5]
#>      lambda[1,1]   lambda[1,2] lambda[1,3] lambda[1,4]   lambda[1,5]
#> [1,]  0.01000000  0.0000000000  0.00000000  0.00000000  0.0000000000
#> [2,]  0.08881814 -0.0069607125  0.04701671  0.05811048 -0.0183519085
#> [3,]  0.09769463 -0.0101249422  0.05003421  0.04333985  0.0009460308
#> [4,]  0.12711317 -0.0092963084  0.05873454  0.02999497 -0.0143671288
#> [5,]  0.12208723 -0.0004291535  0.06095618  0.03279684 -0.0129103679
```

To remove the HDF5 file from disk and remove its path from the metadata, use
`removeChain()`.
